// RevSignal AI - Database Schema
// MVP Version - Core tables for deal scoring and risk detection

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// ENUMS
// =============================================================================

enum SubscriptionTier {
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

enum SubscriptionStatus {
  ACTIVE
  TRIALING
  PAST_DUE
  CANCELED
}

enum UserRole {
  ADMIN
  MANAGER
  MEMBER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INVITED
  SUSPENDED
}

enum CrmProvider {
  SALESFORCE
  HUBSPOT
  PIPEDRIVE
  ZOHO
}

enum IntegrationStatus {
  CONNECTED
  DISCONNECTED
  ERROR
  SYNCING
}

enum DealStatus {
  OPEN
  WON
  LOST
  STALLED
}

enum RiskLevel {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ForecastCategory {
  COMMIT
  BEST_CASE
  PIPELINE
  OMIT
}

enum SignalType {
  EMAIL
  CALL
  MEETING
  ENGAGEMENT
  MARKET
}

enum SignalDirection {
  INBOUND
  OUTBOUND
}

enum SentimentLabel {
  POSITIVE
  NEUTRAL
  NEGATIVE
}

enum SignalPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum ActivityType {
  CALL
  EMAIL
  MEETING
  TASK
  NOTE
  STAGE_CHANGE
}

enum SyncStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// =============================================================================
// CORE TABLES
// =============================================================================

model Organization {
  id                 String             @id @default(uuid())
  name               String
  slug               String             @unique
  domain             String?
  subscriptionTier   SubscriptionTier   @default(STARTER)
  subscriptionStatus SubscriptionStatus @default(TRIALING)
  trialEndsAt        DateTime?
  settings           Json               @default("{}")
  metadata           Json?
  stripeCustomerId   String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  users        User[]
  integrations Integration[]
  accounts     Account[]
  contacts     Contact[]
  deals        Deal[]
  activities   Activity[]
  signals      Signal[]
  forecasts    Forecast[]

  @@index([slug])
  @@index([domain])
  @@index([subscriptionTier, subscriptionStatus])
  @@map("organizations")
}

model User {
  id              String     @id @default(uuid())
  organizationId  String
  email           String     @unique
  emailVerifiedAt DateTime?
  passwordHash    String?
  firstName       String
  lastName        String
  avatarUrl       String?
  role            UserRole   @default(MEMBER)
  status          UserStatus @default(ACTIVE)
  timezone        String?
  preferences     Json       @default("{}")
  lastLoginAt     DateTime?
  crmUserId       String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deals        Deal[]       @relation("DealOwner")
  activities   Activity[]
  forecasts    Forecast[]

  // NextAuth relations
  accounts NextAuthAccount[]
  sessions Session[]

  @@index([organizationId])
  @@index([organizationId, role])
  @@index([crmUserId])
  @@map("users")
}

// NextAuth Account (for OAuth providers)
model NextAuthAccount {
  id                String  @id @default(uuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("next_auth_accounts")
}

model Session {
  id           String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// =============================================================================
// CRM INTEGRATION
// =============================================================================

model Integration {
  id             String            @id @default(uuid())
  organizationId String
  provider       CrmProvider
  accessToken    String            @db.Text // Encrypted
  refreshToken   String?           @db.Text // Encrypted
  tokenExpiresAt DateTime?
  settings       Json              @default("{}")
  status         IntegrationStatus @default(DISCONNECTED)
  lastSyncAt     DateTime?
  syncError      String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  syncLogs     SyncLog[]

  @@unique([organizationId, provider])
  @@index([organizationId])
  @@index([status])
  @@map("integrations")
}

model SyncLog {
  id            String     @id @default(uuid())
  integrationId String
  syncType      String // "full" | "incremental"
  status        SyncStatus @default(PENDING)
  recordsSynced Int        @default(0)
  errors        Json?
  startedAt     DateTime   @default(now())
  completedAt   DateTime?

  // Relations
  integration Integration @relation(fields: [integrationId], references: [id], onDelete: Cascade)

  @@index([integrationId])
  @@index([status])
  @@map("sync_logs")
}

// =============================================================================
// ACCOUNTS & CONTACTS
// =============================================================================

model Account {
  id             String  @id @default(uuid())
  organizationId String
  crmId          String?
  crmSource      CrmProvider?
  name           String
  domain         String?
  industry       String?
  employeeCount  Int?
  annualRevenue  Decimal? @db.Decimal(15, 2)
  healthScore    Int?
  metadata       Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  contacts     Contact[]
  deals        Deal[]

  @@unique([organizationId, crmSource, crmId])
  @@index([organizationId])
  @@index([name])
  @@map("accounts")
}

model Contact {
  id              String       @id @default(uuid())
  organizationId  String
  accountId       String?
  crmId           String?
  crmSource       CrmProvider?
  email           String
  firstName       String
  lastName        String
  title           String?
  phone           String?
  role            String? // "champion", "decision_maker", "influencer", etc.
  engagementScore Int?
  metadata        Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?

  // Relations
  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  account      Account?      @relation(fields: [accountId], references: [id], onDelete: SetNull)
  deals        DealContact[]
  signals      Signal[]

  @@unique([organizationId, crmSource, crmId])
  @@index([organizationId])
  @@index([accountId])
  @@index([email])
  @@map("contacts")
}

model DealContact {
  id        String  @id @default(uuid())
  dealId    String
  contactId String
  role      String? // "champion", "decision_maker", "influencer", "blocker"
  isPrimary Boolean @default(false)

  createdAt DateTime @default(now())

  // Relations
  deal    Deal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contact Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  @@unique([dealId, contactId])
  @@map("deal_contacts")
}

// =============================================================================
// DEALS & SCORING
// =============================================================================

model Deal {
  id               String           @id @default(uuid())
  organizationId   String
  accountId        String?
  ownerId          String
  crmId            String?
  crmSource        CrmProvider?
  name             String
  description      String?
  amount           Decimal?         @db.Decimal(15, 2)
  currency         String           @default("USD")
  stage            String
  stageEnteredAt   DateTime?
  probability      Int? // Manual probability (0-100)
  aiScore          Int? // AI-calculated score (0-100)
  aiWinProbability Decimal?         @db.Decimal(5, 2) // AI win probability %
  aiScoreFactors   Json? // Score breakdown
  riskLevel        RiskLevel?
  riskFactors      Json? // Array of identified risks
  forecastCategory ForecastCategory?
  expectedCloseDate DateTime?       @db.Date
  actualCloseDate  DateTime?        @db.Date
  status           DealStatus       @default(OPEN)
  lossReason       String?
  nextAction       String?
  nextActionDate   DateTime?        @db.Date
  lastActivityAt   DateTime?
  daysInStage      Int?
  velocityScore    Decimal?         @db.Decimal(5, 2)
  customFields     Json?
  metadata         Json?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  syncedAt  DateTime?
  scoredAt  DateTime?

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  account      Account?     @relation(fields: [accountId], references: [id], onDelete: SetNull)
  owner        User         @relation("DealOwner", fields: [ownerId], references: [id])
  contacts     DealContact[]
  scores       DealScore[]
  activities   Activity[]
  signals      Signal[]

  @@unique([organizationId, crmSource, crmId])
  @@index([organizationId])
  @@index([ownerId])
  @@index([accountId])
  @@index([organizationId, stage])
  @@index([organizationId, status])
  @@index([organizationId, expectedCloseDate])
  @@index([organizationId, aiScore(sort: Desc)])
  @@index([organizationId, riskLevel])
  @@index([organizationId, forecastCategory, expectedCloseDate])
  @@map("deals")
}

model DealScore {
  id             String   @id @default(uuid())
  dealId         String
  score          Int // 0-100
  winProbability Decimal  @db.Decimal(5, 2)
  factors        Json // Score breakdown factors
  modelVersion   String   @default("v1")
  calculatedAt   DateTime @default(now())

  // Relations
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@index([dealId])
  @@index([calculatedAt])
  @@map("deal_scores")
}

// =============================================================================
// SIGNALS & ACTIVITIES
// =============================================================================

model Signal {
  id             String          @id @default(uuid())
  organizationId String
  dealId         String
  contactId      String?
  type           SignalType
  subtype        String?
  source         String // "gmail", "outlook", "salesforce", etc.
  sourceId       String?
  direction      SignalDirection?
  title          String?
  content        String?         @db.Text
  contentSummary String?         @db.Text // AI-generated summary
  sentimentScore Decimal?        @db.Decimal(4, 3) // -1 to 1
  sentimentLabel SentimentLabel?
  engagementScore Decimal?       @db.Decimal(5, 2) // 0-100
  impactScore    Decimal?        @db.Decimal(5, 2) // 0-100
  priority       SignalPriority  @default(MEDIUM)
  isPositive     Boolean?
  entities       Json? // Extracted entities
  keywords       String[]
  embeddingId    String? // Vector embedding ID (Pinecone)
  metadata       Json?

  occurredAt  DateTime  @default(now())
  processedAt DateTime?
  createdAt   DateTime  @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deal         Deal         @relation(fields: [dealId], references: [id], onDelete: Cascade)
  contact      Contact?     @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@index([dealId])
  @@index([organizationId, dealId])
  @@index([organizationId, type])
  @@index([organizationId, occurredAt(sort: Desc)])
  @@index([organizationId, priority, occurredAt(sort: Desc)])
  @@index([source, sourceId])
  @@map("signals")
}

model Activity {
  id             String       @id @default(uuid())
  organizationId String
  dealId         String?
  userId         String
  contactId      String?
  type           ActivityType
  subject        String?
  description    String?      @db.Text
  outcome        String?
  durationMinutes Int?
  dueAt          DateTime?
  completedAt    DateTime?
  isAiRecommended Boolean     @default(false)
  metadata       Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  deal         Deal?        @relation(fields: [dealId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id])

  @@index([organizationId])
  @@index([dealId])
  @@index([userId])
  @@index([type])
  @@map("activities")
}

// =============================================================================
// FORECASTING
// =============================================================================

model Forecast {
  id                   String   @id @default(uuid())
  organizationId       String
  userId               String?
  periodType           String // "monthly", "quarterly", "annual"
  periodStart          DateTime @db.Date
  periodEnd            DateTime @db.Date
  quota                Decimal? @db.Decimal(15, 2)
  commitAmount         Decimal  @db.Decimal(15, 2)
  bestCaseAmount       Decimal  @db.Decimal(15, 2)
  pipelineAmount       Decimal  @db.Decimal(15, 2)
  aiPredictedAmount    Decimal? @db.Decimal(15, 2)
  aiConfidence         Decimal? @db.Decimal(5, 2)
  aiConfidenceInterval Json? // {low, high}
  closedWonAmount      Decimal  @default(0) @db.Decimal(15, 2)
  factors              Json?
  calculatedAt         DateTime @default(now())

  createdAt DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@index([periodStart, periodEnd])
  @@map("forecasts")
}
